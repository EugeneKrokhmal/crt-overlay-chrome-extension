{"version":3,"file":"background.js","sources":["../../src/shared/config.js","../../src/shared/chrome-facade.js","../../src/shared/logger.js","../../src/background.js"],"sourcesContent":["/**\n * Shared configuration for CRT overlay extension.\n * Single source of truth for storage keys, defaults, and message types.\n *\n * When adding a new option:\n * 1. Add key to STORAGE_KEYS and value to DEFAULT_OPTIONS.\n * 2. Add to STORAGE_KEYS_LIST.\n * 3. If it's a slider: add to OPTION_SLIDER_KEYS and to STORAGE_KEY_TO_OPTION / OPTION_TO_STORAGE_KEY.\n * 4. In popup.js: add to POPUP_IDS, and to SLIDER_RANGE / FILL_IDS if it's a slider.\n */\n\nexport const STORAGE_KEYS = {\n  ENABLED: \"crtEnabled\",\n  SCANLINE: \"scanlineIntensity\",\n  VIGNETTE: \"vignetteIntensity\",\n  CURVATURE: \"curvatureIntensity\",\n  GLOW: \"glowIntensity\",\n  SOUND_FILTER: \"soundFilterEnabled\",\n  SOUND_EFFECT_LEVEL: \"soundEffectLevel\",\n  SOUND_NOISE_LEVEL: \"soundNoiseLevel\",\n  VHS_GLITCHES: \"vhsGlitchesEnabled\",\n  GLITCH_PHASE_LEVEL: \"glitchPhaseLevel\",\n  GLITCH_NOISE_LEVEL: \"glitchNoiseLevel\",\n};\n\nexport const DEFAULT_OPTIONS = {\n  [STORAGE_KEYS.ENABLED]: false,\n  [STORAGE_KEYS.SCANLINE]: 0.4,\n  [STORAGE_KEYS.VIGNETTE]: 0.5,\n  [STORAGE_KEYS.CURVATURE]: 0.15,\n  [STORAGE_KEYS.GLOW]: 0.1,\n  [STORAGE_KEYS.SOUND_FILTER]: false,\n  [STORAGE_KEYS.SOUND_EFFECT_LEVEL]: 0.8,\n  [STORAGE_KEYS.SOUND_NOISE_LEVEL]: 0.6,\n  [STORAGE_KEYS.VHS_GLITCHES]: false,\n  [STORAGE_KEYS.GLITCH_PHASE_LEVEL]: 0.3,\n  [STORAGE_KEYS.GLITCH_NOISE_LEVEL]: 0.15,\n};\n\n/** All storage keys as array for batch get/set */\nexport const STORAGE_KEYS_LIST = [\n  STORAGE_KEYS.ENABLED,\n  STORAGE_KEYS.SCANLINE,\n  STORAGE_KEYS.VIGNETTE,\n  STORAGE_KEYS.CURVATURE,\n  STORAGE_KEYS.GLOW,\n  STORAGE_KEYS.SOUND_FILTER,\n  STORAGE_KEYS.SOUND_EFFECT_LEVEL,\n  STORAGE_KEYS.SOUND_NOISE_LEVEL,\n  STORAGE_KEYS.VHS_GLITCHES,\n  STORAGE_KEYS.GLITCH_PHASE_LEVEL,\n  STORAGE_KEYS.GLITCH_NOISE_LEVEL,\n];\n\n/** Option keys that are sliders (excludes ENABLED and SOUND_FILTER) */\nexport const OPTION_SLIDER_KEYS = [\n  STORAGE_KEYS.SCANLINE,\n  STORAGE_KEYS.VIGNETTE,\n  STORAGE_KEYS.CURVATURE,\n  STORAGE_KEYS.GLOW,\n];\n\nexport const MESSAGE = {\n  TOGGLE: \"toggle\",\n  SET_OPTIONS: \"setOptions\",\n  GET_STATE: \"getState\",\n};\n\n/**\n * Standard message response shape: { ok: boolean, data?: unknown }.\n * Async handlers must return a Promise that resolves to this; the listener must return true\n * when the handler is async so sendResponse remains valid.\n */\nexport function messageResponse(ok, data = undefined) {\n  return data === undefined ? { ok } : { ok, data };\n}\n\n/** Map storage key to option name (camelCase) */\nexport const STORAGE_KEY_TO_OPTION = {\n  [STORAGE_KEYS.SCANLINE]: \"scanline\",\n  [STORAGE_KEYS.VIGNETTE]: \"vignette\",\n  [STORAGE_KEYS.CURVATURE]: \"curvature\",\n  [STORAGE_KEYS.GLOW]: \"glow\",\n};\n\n/** Option name to storage key (reverse map) */\nexport const OPTION_TO_STORAGE_KEY = {\n  scanline: STORAGE_KEYS.SCANLINE,\n  vignette: STORAGE_KEYS.VIGNETTE,\n  curvature: STORAGE_KEYS.CURVATURE,\n  glow: STORAGE_KEYS.GLOW,\n};\n\n/** URL prefixes for tabs we must not send messages to */\nexport const RESTRICTED_URL_PREFIXES = [\"chrome://\", \"chrome-extension://\", \"edge://\"];\n\n/** True if we can sendMessage to this tab */\nexport function isMessageableTab(tab) {\n  return tab.id && tab.url && !RESTRICTED_URL_PREFIXES.some((p) => tab.url.startsWith(p));\n}\n","/**\n * Thin facade over chrome.storage.local and chrome.tabs for content/popup/background.\n * Enables tests to mock storage and messaging by replacing this module.\n */\n\nimport { isMessageableTab } from \"./config.js\";\n\nexport const storage = {\n  get(keys, callback) {\n    chrome.storage.local.get(keys, callback);\n  },\n  set(items, callback) {\n    chrome.storage.local.set(items, callback ?? (() => {}));\n  },\n};\n\nexport const tabs = {\n  /**\n   * Send a message to all tabs that accept content scripts (excludes chrome:// etc).\n   * @param {object} message\n   * @param {(err?: Error) => void} [onSent] called per tab (errors are passed)\n   */\n  sendToMessageableTabs(message, onSent) {\n    chrome.tabs.query({}, (tabList) => {\n      const messageable = tabList.filter(isMessageableTab);\n      messageable.forEach((tab) => {\n        chrome.tabs\n          .sendMessage(tab.id, message)\n          .then(() => onSent?.())\n          .catch((err) => onSent?.(err));\n      });\n    });\n  },\n};\n","/**\n * Dev-only logging. Logs only when extension is unpacked (no update_url) to avoid leaking info in production.\n */\nfunction isDebug() {\n  try {\n    const manifest = chrome?.runtime?.getManifest?.();\n    return !manifest?.update_url;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Log a warning when debug mode is on (unpacked extension). No-op in production.\n * @param {string} message\n * @param {unknown} [err]\n */\nexport function logExtensionWarning(message, err) {\n  if (!isDebug()) return;\n  if (err != null) {\n    console.warn(`[CRT Overlay] ${message}`, err);\n  } else {\n    console.warn(`[CRT Overlay] ${message}`);\n  }\n}\n","/**\n * Service worker: install defaults and keyboard command to toggle overlay.\n */\nimport { STORAGE_KEYS, DEFAULT_OPTIONS, MESSAGE } from \"./shared/config.js\";\nimport { storage, tabs } from \"./shared/chrome-facade.js\";\nimport { logExtensionWarning } from \"./shared/logger.js\";\n\nconst COMMAND_TOGGLE = \"toggle-crt\";\n\nfunction broadcastToggle(enabled) {\n  tabs.sendToMessageableTabs(\n    { type: MESSAGE.TOGGLE, enabled },\n    (err) => err && logExtensionWarning(\"Background: sendMessage to tab failed\", err)\n  );\n}\n\nchrome.runtime.onInstalled.addListener(() => {\n  storage.get(null, (data) => {\n    const next = { ...DEFAULT_OPTIONS };\n    Object.keys(next).forEach((k) => {\n      if (data[k] !== undefined) next[k] = data[k];\n    });\n    storage.set(next);\n  });\n});\n\nchrome.commands.onCommand.addListener((command) => {\n  if (command !== COMMAND_TOGGLE) return;\n\n  storage.get(STORAGE_KEYS.ENABLED, (data) => {\n    const next = !data[STORAGE_KEYS.ENABLED];\n    storage.set({ [STORAGE_KEYS.ENABLED]: next }, () => {\n      broadcastToggle(next);\n    });\n  });\n});\n"],"names":[],"mappings":"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"}