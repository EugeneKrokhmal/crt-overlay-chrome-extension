var W=Object.defineProperty;var k=(s,o,E)=>o in s?W(s,o,{enumerable:!0,configurable:!0,writable:!0,value:E}):s[o]=E;var _=(s,o,E)=>k(s,typeof o!="symbol"?o+"":o,E);(function(){"use strict";const s={ENABLED:"crtEnabled",SCANLINE:"scanlineIntensity",VIGNETTE:"vignetteIntensity",GLOW:"glowIntensity",SOUND_FILTER:"soundFilterEnabled",SOUND_EFFECT_LEVEL:"soundEffectLevel",SOUND_NOISE_LEVEL:"soundNoiseLevel",VHS_GLITCHES:"vhsGlitchesEnabled",GLITCH_PHASE_LEVEL:"glitchPhaseLevel",GLITCH_NOISE_LEVEL:"glitchNoiseLevel",GLITCH_TRACKING_LEVEL:"glitchTrackingLevel",GLITCH_WOBBLE_LEVEL:"glitchWobbleLevel",GLITCH_HEADSWITCH_LEVEL:"glitchHeadswitchLevel",GLITCH_RGB_LEVEL:"glitchRgbLevel",GLITCH_DROPOUT_LEVEL:"glitchDropoutLevel"},o={[s.ENABLED]:!1,[s.SCANLINE]:.4,[s.VIGNETTE]:.5,[s.GLOW]:.15,[s.SOUND_FILTER]:!1,[s.SOUND_EFFECT_LEVEL]:.8,[s.SOUND_NOISE_LEVEL]:.6,[s.VHS_GLITCHES]:!1,[s.GLITCH_PHASE_LEVEL]:.3,[s.GLITCH_NOISE_LEVEL]:.15,[s.GLITCH_TRACKING_LEVEL]:.5,[s.GLITCH_WOBBLE_LEVEL]:.3,[s.GLITCH_HEADSWITCH_LEVEL]:.25,[s.GLITCH_RGB_LEVEL]:.35,[s.GLITCH_DROPOUT_LEVEL]:.2},E=[s.ENABLED,s.SCANLINE,s.VIGNETTE,s.GLOW,s.SOUND_FILTER,s.SOUND_EFFECT_LEVEL,s.SOUND_NOISE_LEVEL,s.VHS_GLITCHES,s.GLITCH_PHASE_LEVEL,s.GLITCH_NOISE_LEVEL,s.GLITCH_TRACKING_LEVEL,s.GLITCH_WOBBLE_LEVEL,s.GLITCH_HEADSWITCH_LEVEL,s.GLITCH_RGB_LEVEL,s.GLITCH_DROPOUT_LEVEL],G=[s.SCANLINE,s.VIGNETTE,s.GLOW],m={TOGGLE:"toggle",SET_OPTIONS:"setOptions",GET_STATE:"getState"};function b(i,e=void 0){return e===void 0?{ok:i}:{ok:i,data:e}}const H={[s.SCANLINE]:"scanline",[s.VIGNETTE]:"vignette",[s.GLOW]:"glow"},T={get(i,e){chrome.storage.local.get(i,e)},set(i,e){chrome.storage.local.set(i,e??(()=>{}))}};function N(){var i,e;try{const t=(e=(i=chrome==null?void 0:chrome.runtime)==null?void 0:i.getManifest)==null?void 0:e.call(i);return!(t!=null&&t.update_url)}catch{return!1}}function g(i,e){N()&&(e!=null?console.warn(`[CRT Overlay] ${i}`,e):console.warn(`[CRT Overlay] ${i}`))}const y="data-crt-sound-hooked",A=2e3,V=.5,C=.06,w=1;function R(i,e=3){const t=i.sampleRate,r=t*e,n=i.createBuffer(1,r,t),l=n.getChannelData(0);let h=0,c=0,a=0;for(let u=0;u<r;u++){const d=(Math.random()*2-1)*.5;h=.99886*h+d*.0555179,c=.99332*c+d*.0750759,a=.969*a+d*.153852,l[u]=h+c+a}return n}class F{constructor(){this._ctx=null,this._enabled=!1,this._effectLevel=.8,this._noiseLevel=.6,this._nodesByElement=new WeakMap,this._observer=null,this._observerThrottleTimer=null,this._resumeOnInteraction=null}_getContext(){return this._ctx||(this._ctx=new(window.AudioContext||window.webkitAudioContext)),this._ctx}_ensureContextRunning(){const e=this._ctx;if(!e||e.state==="running")return Promise.resolve();const t=e.resume();return t&&typeof t.then=="function"?t.catch(r=>g("VHS sound: AudioContext resume failed",r)):Promise.resolve()}_addResumeOnInteraction(){if(this._resumeOnInteraction)return;const e=()=>{this._ensureContextRunning(),document.removeEventListener("click",e),document.removeEventListener("touchstart",e),document.removeEventListener("keydown",e),this._resumeOnInteraction=null};this._resumeOnInteraction=e,document.addEventListener("click",e,{passive:!0}),document.addEventListener("touchstart",e,{passive:!0}),document.addEventListener("keydown",e,{passive:!0})}_createChain(e,t){const r=e.createGain(),n=e.createBiquadFilter();n.type="lowpass",n.frequency.value=A,n.Q.value=V;const l=e.createGain(),h=R(e),c=e.createBufferSource();c.buffer=h,c.loop=!0;const a=e.createGain();a.gain.value=this._noiseLevel*C,t.connect(r),r.connect(e.destination),t.connect(n),n.connect(l),l.connect(e.destination),c.connect(a),a.connect(e.destination);try{c.start(0)}catch(u){g("VHS sound: noise source start failed",u)}return{dryGain:r,effectGain:l,noiseGain:a}}_hookElement(e){if(!e.hasAttribute(y))try{const t=this._getContext(),r=t.createMediaElementSource(e),n=this._createChain(t,r);this._nodesByElement.set(e,{source:r,...n}),e.setAttribute(y,"1"),this._setChainEnabled(n,this._enabled)}catch(t){g("VHS sound: hook element failed (e.g. CORS)",t)}}_setChainEnabled(e,t){if(!e)return;const r=t?Math.pow(this._effectLevel,.85):0,n=r*w,l=t?Math.max(0,1-r):1;e.dryGain.gain.value=l,e.effectGain.gain.value=n;const h=t?Math.pow(this._noiseLevel,1.6):0;e.noiseGain.gain.value=h*C}setLevels(e,t){this._effectLevel=Math.max(0,Math.min(1,Number(e)||0)),this._noiseLevel=Math.max(0,Math.min(1,Number(t)||0)),document.querySelectorAll("audio, video").forEach(r=>{const n=this._nodesByElement.get(r);n&&this._setChainEnabled(n,this._enabled)})}_scanAndHook(){document.querySelectorAll("audio, video").forEach(t=>this._hookElement(t))}setEnabled(e,t,r){e!==void 0&&(this._enabled=!!e),t!==void 0&&(this._effectLevel=Math.max(0,Math.min(1,Number(t)||0))),r!==void 0&&(this._noiseLevel=Math.max(0,Math.min(1,Number(r)||0))),this._enabled?(this._ensureContextRunning().then(()=>{this._scanAndHook(),this._observe()}),this._addResumeOnInteraction()):this._disconnectObserver(),this.syncChains()}_observe(){if(this._observer)return;const e=document.body||document.documentElement;if(!e)return;const t=250;this._observer=new MutationObserver(()=>{this._enabled&&this._observerThrottleTimer==null&&(this._observerThrottleTimer=setTimeout(()=>{this._observerThrottleTimer=null,this._scanAndHook()},t))}),this._observer.observe(e,{childList:!0,subtree:!0})}_disconnectObserver(){this._observerThrottleTimer!=null&&(clearTimeout(this._observerThrottleTimer),this._observerThrottleTimer=null),this._observer&&(this._observer.disconnect(),this._observer=null)}syncChains(){document.querySelectorAll("audio, video").forEach(e=>{const t=this._nodesByElement.get(e);t&&this._setChainEnabled(t,this._enabled)})}}const D="crt-overlay-root",M="#crt-curve-inner";class x{constructor(){_(this,"_noiseFrameId",null);_(this,"_noiseCanvas",null);_(this,"_noiseFrameCount",0);_(this,"_dropoutFrameId",null);_(this,"_dropoutTimeoutId",null);_(this,"_dropoutCanvas",null);this._root=null}getRoot(){return this._root?this._root:(this._injectRgbFilterSvg(),this._root=this._createDOM(),document.body.appendChild(this._root),this._resizeOverlay(),this._resizeObserver=new ResizeObserver(()=>this._resizeOverlay()),this._resizeObserver.observe(document.documentElement),this._resizeScrollListener=()=>{this._resizeScrollTimer&&clearTimeout(this._resizeScrollTimer),this._resizeScrollTimer=setTimeout(()=>{this._resizeScrollTimer=null,this._resizeOverlay()},100)},window.addEventListener("scroll",this._resizeScrollListener,{passive:!0}),this._root)}_createDOM(){const e=document.createElement("div");e.id=D,e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const t=document.createElement("div");t.id="crt-curve-wrap";const r=document.createElement("div");r.id="crt-curve-inner",["crt-scanlines","crt-vignette","crt-glow","crt-chromatic","crt-glitch-phase","crt-tracking-lines","crt-headswitch"].forEach(u=>{const d=document.createElement("div");d.id=u,r.appendChild(d)});const l=document.createElement("div");l.id="crt-glitch-noise-wrap";const h=document.createElement("canvas");h.id="crt-glitch-noise",l.appendChild(h),r.appendChild(l);const c=document.createElement("div");c.id="crt-glitch-dropout-wrap";const a=document.createElement("canvas");return a.id="crt-glitch-dropout",c.appendChild(a),r.appendChild(c),t.appendChild(r),e.appendChild(t),e}_injectRgbFilterSvg(){if(document.getElementById("crt-vhs-rgb"))return;const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("aria-hidden","true"),e.style.cssText="position:absolute;width:0;height:0;pointer-events:none;visibility:hidden",e.innerHTML=`
      <defs>
        <filter id="crt-vhs-rgb" x="-5%" y="-5%" width="110%" height="110%">
          <feColorMatrix in="SourceGraphic" type="matrix" result="r_src"
            values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0"/>
          <feOffset id="crt-vhs-rgb-r-offset" in="r_src" dx="-2" result="r"/>
          <feColorMatrix in="SourceGraphic" type="matrix" result="g"
            values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0"/>
          <feColorMatrix in="SourceGraphic" type="matrix" result="b_src"
            values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0"/>
          <feOffset id="crt-vhs-rgb-b-offset" in="b_src" dx="2" result="b"/>
          <feBlend in="r" in2="g" mode="lighten" result="rg"/>
          <feBlend in="rg" in2="b" mode="lighten" result="rgbSplit"/>
          <feColorMatrix in="rgbSplit" type="matrix" result="rgbSplitAlpha"
            values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.5 0"/>
          <feBlend in="SourceGraphic" in2="rgbSplitAlpha" mode="normal" result="out"/>
        </filter>
      </defs>
    `,document.body.insertBefore(e,document.body.firstChild)}_resizeOverlay(){if(!this._root)return;const e=document.documentElement,t=Math.max(e.scrollWidth,e.clientWidth),r=Math.max(e.scrollHeight,e.clientHeight);this._root.style.width=t+"px",this._root.style.height=r+"px"}applyOptions(e={}){const t=this.getRoot(),r=t.querySelector(M);if(!r)return;r.style.setProperty("--crt-scanline",String(e.scanline??o[s.SCANLINE])),r.style.setProperty("--crt-vignette",String(e.vignette??o[s.VIGNETTE])),r.style.setProperty("--crt-glow",String(e.glow??o[s.GLOW]));const n=e.vhsGlitches??o[s.VHS_GLITCHES],l=e.glitchPhaseLevel??o[s.GLITCH_PHASE_LEVEL],h=e.glitchNoiseLevel??o[s.GLITCH_NOISE_LEVEL],c=e.glitchTrackingLevel??o[s.GLITCH_TRACKING_LEVEL],a=e.glitchWobbleLevel??o[s.GLITCH_WOBBLE_LEVEL],u=e.glitchHeadswitchLevel??o[s.GLITCH_HEADSWITCH_LEVEL],d=e.glitchRgbLevel??o[s.GLITCH_RGB_LEVEL],L=e.glitchDropoutLevel??o[s.GLITCH_DROPOUT_LEVEL];n?(t.setAttribute("data-glitches","true"),t.style.setProperty("--crt-glitch-phase",String(l)),t.style.setProperty("--crt-glitch-noise",String(h)),t.style.setProperty("--crt-tracking-lines",String(c)),t.style.setProperty("--crt-wobble-px",a>.01?String(.5+a*2.5):"0"),t.style.setProperty("--crt-headswitch",String(u)),t.style.setProperty("--crt-glitch-dropout",String(L)),this._startNoiseCanvas(h),this._applyRgbFilter(d),this._startDropoutCanvas(L),a>.01&&t.hasAttribute("data-visible")?(document.body.classList.add("crt-body-wobble"),document.body.style.setProperty("--crt-wobble-px",String(.5+a*2.5))):(document.body.classList.remove("crt-body-wobble"),document.body.style.removeProperty("--crt-wobble-px"))):(t.removeAttribute("data-glitches"),this._stopNoiseCanvas(),this._stopDropoutCanvas(),this._applyRgbFilter(0),document.body.classList.remove("crt-body-wobble"),document.body.style.removeProperty("--crt-wobble-px"))}_applyRgbFilter(e){const t=Math.round(e*5),r=document.getElementById("crt-vhs-rgb-r-offset"),n=document.getElementById("crt-vhs-rgb-b-offset");r&&r.setAttribute("dx",String(-t)),n&&n.setAttribute("dx",String(t));const l=document.documentElement;e>.01?l.style.filter="url(#crt-vhs-rgb)":l.style.filter=""}_startNoiseCanvas(e){this._stopNoiseCanvas();const t=this.getRoot().querySelector("#crt-glitch-noise-wrap"),r=this.getRoot().querySelector("#crt-glitch-noise");if(!t||!r)return;this._noiseCanvas=r;const n=128;r.width=n,r.height=n,t.style.display="block";const l=r.getContext("2d",{willReadFrequently:!1,alpha:!0}),h=l.createImageData(n,n),c=h.data;this._noiseFrameCount=0;const a=()=>{if(!this._noiseCanvas||!this.getRoot().hasAttribute("data-glitches"))return;if(this._noiseFrameCount++,this._noiseFrameCount%2!==0){this._noiseFrameId=requestAnimationFrame(a);return}const u=parseFloat(this.getRoot().style.getPropertyValue("--crt-glitch-noise")||"0.15"),d=Math.floor(u*80),L=this._noiseFrameCount*.02;for(let v=0;v<n;v++){const P=.35+.65*(.5+.5*Math.sin(v*.06+L));for(let f=0;f<n;f++){const p=(v*n+f)*4,B=Math.random()*256|0;c[p]=c[p+1]=c[p+2]=B,c[p+3]=Math.random()>.12?Math.floor(d*P*(.6+.4*Math.random())):0}}l.putImageData(h,0,0),this._noiseFrameId=requestAnimationFrame(a)};a()}_stopNoiseCanvas(){this._noiseFrameId!=null&&(cancelAnimationFrame(this._noiseFrameId),this._noiseFrameId=null);const e=this.getRoot().querySelector("#crt-glitch-noise-wrap");e&&(e.style.display="none"),this._noiseCanvas=null}_startDropoutCanvas(e){if(this._stopDropoutCanvas(),e<.02)return;const t=this.getRoot().querySelector("#crt-glitch-dropout-wrap"),r=this.getRoot().querySelector("#crt-glitch-dropout");if(!t||!r)return;this._dropoutCanvas=r;const n=256,l=256;r.width=n,r.height=l,t.style.display="block",t.style.opacity=String(e);const h=r.getContext("2d",{willReadFrequently:!1,alpha:!0}),c=()=>{if(!this._dropoutCanvas||!this.getRoot().hasAttribute("data-glitches"))return;h.clearRect(0,0,n,l);const a=4+Math.floor(e*12);for(let u=0;u<a;u++){const d=Math.floor(Math.random()*l),L=Math.random()>.7?2:1;h.fillStyle=`rgba(0,0,0,${.3+Math.random()*.5})`,h.fillRect(0,d,n,L)}this._dropoutTimeoutId=setTimeout(()=>{this._dropoutFrameId=requestAnimationFrame(c)},80+Math.random()*120)};c()}_stopDropoutCanvas(){this._dropoutFrameId!=null&&(cancelAnimationFrame(this._dropoutFrameId),this._dropoutFrameId=null),this._dropoutTimeoutId!=null&&(clearTimeout(this._dropoutTimeoutId),this._dropoutTimeoutId=null);const e=this.getRoot().querySelector("#crt-glitch-dropout-wrap");e&&(e.style.display="none",e.style.opacity=""),this._dropoutCanvas=null}setVisible(e){const t=this.getRoot();if(e){if(t.setAttribute("data-visible","true"),t.hasAttribute("data-glitches")){this._startNoiseCanvas(parseFloat(t.style.getPropertyValue("--crt-glitch-noise")||"0.15"));const r=t.style.getPropertyValue("--crt-wobble-px");r&&parseFloat(r)>0&&(document.body.classList.add("crt-body-wobble"),document.body.style.setProperty("--crt-wobble-px",r))}}else t.removeAttribute("data-visible"),this._stopNoiseCanvas(),this._stopDropoutCanvas(),document.body.classList.remove("crt-body-wobble"),document.body.style.removeProperty("--crt-wobble-px")}initFromStorage(e){const t={};for(const r of G){const n=H[r];n&&(t[n]=e[r]??o[r])}t.vhsGlitches=e[s.VHS_GLITCHES]??o[s.VHS_GLITCHES],t.glitchPhaseLevel=e[s.GLITCH_PHASE_LEVEL]??o[s.GLITCH_PHASE_LEVEL],t.glitchNoiseLevel=e[s.GLITCH_NOISE_LEVEL]??o[s.GLITCH_NOISE_LEVEL],t.glitchTrackingLevel=e[s.GLITCH_TRACKING_LEVEL]??o[s.GLITCH_TRACKING_LEVEL],t.glitchWobbleLevel=e[s.GLITCH_WOBBLE_LEVEL]??o[s.GLITCH_WOBBLE_LEVEL],t.glitchHeadswitchLevel=e[s.GLITCH_HEADSWITCH_LEVEL]??o[s.GLITCH_HEADSWITCH_LEVEL],t.glitchRgbLevel=e[s.GLITCH_RGB_LEVEL]??o[s.GLITCH_RGB_LEVEL],t.glitchDropoutLevel=e[s.GLITCH_DROPOUT_LEVEL]??o[s.GLITCH_DROPOUT_LEVEL],this.getRoot(),this.applyOptions(t),e[s.ENABLED]&&this.setVisible(!0)}handleMessage(e){if(e.type===m.TOGGLE)return this.setVisible(e.enabled),b(!0);if(e.type===m.SET_OPTIONS){const t=e.options||{};return this.applyOptions(t),this.setVisible(e.visible!==!1),b(!0)}return e.type===m.GET_STATE?new Promise(t=>{T.get(s.ENABLED,r=>{t(b(!0,{enabled:!!r[s.ENABLED]}))})}):null}}const S=new x,I=new F;chrome.runtime.onMessage.addListener((i,e,t)=>{const r=S.handleMessage(i);if(i.type===m.SET_OPTIONS&&i.options){const n=i.options;I.setEnabled(n.soundFilter,n.soundEffectLevel,n.soundNoiseLevel)}return r&&typeof r.then=="function"?(r.then(t),!0):r!=null?(t(r),!0):!1});function O(){T.get(E,i=>{S.initFromStorage(i);const e=i[s.SOUND_FILTER]??o[s.SOUND_FILTER],t=i[s.SOUND_EFFECT_LEVEL]??o[s.SOUND_EFFECT_LEVEL],r=i[s.SOUND_NOISE_LEVEL]??o[s.SOUND_NOISE_LEVEL];I.setEnabled(!!e,t,r)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O()})();
