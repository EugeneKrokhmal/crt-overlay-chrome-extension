var M=Object.defineProperty;var P=(n,r,_)=>r in n?M(n,r,{enumerable:!0,configurable:!0,writable:!0,value:_}):n[r]=_;var f=(n,r,_)=>P(n,typeof r!="symbol"?r+"":r,_);(function(){"use strict";const n={ENABLED:"crtEnabled",SCANLINE:"scanlineIntensity",VIGNETTE:"vignetteIntensity",CURVATURE:"curvatureIntensity",GLOW:"glowIntensity",SOUND_FILTER:"soundFilterEnabled",SOUND_EFFECT_LEVEL:"soundEffectLevel",SOUND_NOISE_LEVEL:"soundNoiseLevel",VHS_GLITCHES:"vhsGlitchesEnabled",GLITCH_PHASE_LEVEL:"glitchPhaseLevel",GLITCH_NOISE_LEVEL:"glitchNoiseLevel"},r={[n.ENABLED]:!1,[n.SCANLINE]:.4,[n.VIGNETTE]:.5,[n.CURVATURE]:.15,[n.GLOW]:.1,[n.SOUND_FILTER]:!1,[n.SOUND_EFFECT_LEVEL]:.8,[n.SOUND_NOISE_LEVEL]:.6,[n.VHS_GLITCHES]:!1,[n.GLITCH_PHASE_LEVEL]:.3,[n.GLITCH_NOISE_LEVEL]:.15},_=[n.ENABLED,n.SCANLINE,n.VIGNETTE,n.CURVATURE,n.GLOW,n.SOUND_FILTER,n.SOUND_EFFECT_LEVEL,n.SOUND_NOISE_LEVEL,n.VHS_GLITCHES,n.GLITCH_PHASE_LEVEL,n.GLITCH_NOISE_LEVEL],O=[n.SCANLINE,n.VIGNETTE,n.CURVATURE,n.GLOW],d={TOGGLE:"toggle",SET_OPTIONS:"setOptions",GET_STATE:"getState"};function L(o,e=void 0){return e===void 0?{ok:o}:{ok:o,data:e}}const I={[n.SCANLINE]:"scanline",[n.VIGNETTE]:"vignette",[n.CURVATURE]:"curvature",[n.GLOW]:"glow"},S={get(o,e){chrome.storage.local.get(o,e)},set(o,e){chrome.storage.local.set(o,e??(()=>{}))}};function p(){var o,e;try{const t=(e=(o=chrome==null?void 0:chrome.runtime)==null?void 0:o.getManifest)==null?void 0:e.call(o);return!(t!=null&&t.update_url)}catch{return!1}}function v(o,e){p()&&(e!=null?console.warn(`[CRT Overlay] ${o}`,e):console.warn(`[CRT Overlay] ${o}`))}const T="data-crt-sound-hooked",b=2e3,y=.5,m=.06,A=1;function R(o,e=3){const t=o.sampleRate,s=t*e,i=o.createBuffer(1,s,t),l=i.getChannelData(0);let u=0,a=0,c=0;for(let E=0;E<s;E++){const h=(Math.random()*2-1)*.5;u=.99886*u+h*.0555179,a=.99332*a+h*.0750759,c=.969*c+h*.153852,l[E]=u+a+c}return i}class G{constructor(){this._ctx=null,this._enabled=!1,this._effectLevel=.8,this._noiseLevel=.6,this._nodesByElement=new WeakMap,this._observer=null,this._observerThrottleTimer=null,this._resumeOnInteraction=null}_getContext(){return this._ctx||(this._ctx=new(window.AudioContext||window.webkitAudioContext)),this._ctx}_ensureContextRunning(){const e=this._ctx;if(!e||e.state==="running")return Promise.resolve();const t=e.resume();return t&&typeof t.then=="function"?t.catch(s=>v("VHS sound: AudioContext resume failed",s)):Promise.resolve()}_addResumeOnInteraction(){if(this._resumeOnInteraction)return;const e=()=>{this._ensureContextRunning(),document.removeEventListener("click",e),document.removeEventListener("touchstart",e),document.removeEventListener("keydown",e),this._resumeOnInteraction=null};this._resumeOnInteraction=e,document.addEventListener("click",e,{passive:!0}),document.addEventListener("touchstart",e,{passive:!0}),document.addEventListener("keydown",e,{passive:!0})}_createChain(e,t){const s=e.createGain(),i=e.createBiquadFilter();i.type="lowpass",i.frequency.value=b,i.Q.value=y;const l=e.createGain(),u=R(e),a=e.createBufferSource();a.buffer=u,a.loop=!0;const c=e.createGain();c.gain.value=this._noiseLevel*m,t.connect(s),s.connect(e.destination),t.connect(i),i.connect(l),l.connect(e.destination),a.connect(c),c.connect(e.destination);try{a.start(0)}catch(E){v("VHS sound: noise source start failed",E)}return{dryGain:s,effectGain:l,noiseGain:c}}_hookElement(e){if(!e.hasAttribute(T))try{const t=this._getContext(),s=t.createMediaElementSource(e),i=this._createChain(t,s);this._nodesByElement.set(e,{source:s,...i}),e.setAttribute(T,"1"),this._setChainEnabled(i,this._enabled)}catch(t){v("VHS sound: hook element failed (e.g. CORS)",t)}}_setChainEnabled(e,t){if(!e)return;const s=t?Math.pow(this._effectLevel,.85):0,i=s*A,l=t?Math.max(0,1-s):1;e.dryGain.gain.value=l,e.effectGain.gain.value=i;const u=t?Math.pow(this._noiseLevel,1.6):0;e.noiseGain.gain.value=u*m}setLevels(e,t){this._effectLevel=Math.max(0,Math.min(1,Number(e)||0)),this._noiseLevel=Math.max(0,Math.min(1,Number(t)||0)),document.querySelectorAll("audio, video").forEach(s=>{const i=this._nodesByElement.get(s);i&&this._setChainEnabled(i,this._enabled)})}_scanAndHook(){document.querySelectorAll("audio, video").forEach(t=>this._hookElement(t))}setEnabled(e,t,s){e!==void 0&&(this._enabled=!!e),t!==void 0&&(this._effectLevel=Math.max(0,Math.min(1,Number(t)||0))),s!==void 0&&(this._noiseLevel=Math.max(0,Math.min(1,Number(s)||0))),this._enabled?(this._ensureContextRunning().then(()=>{this._scanAndHook(),this._observe()}),this._addResumeOnInteraction()):this._disconnectObserver(),this.syncChains()}_observe(){if(this._observer)return;const e=document.body||document.documentElement;if(!e)return;const t=250;this._observer=new MutationObserver(()=>{this._enabled&&this._observerThrottleTimer==null&&(this._observerThrottleTimer=setTimeout(()=>{this._observerThrottleTimer=null,this._scanAndHook()},t))}),this._observer.observe(e,{childList:!0,subtree:!0})}_disconnectObserver(){this._observerThrottleTimer!=null&&(clearTimeout(this._observerThrottleTimer),this._observerThrottleTimer=null),this._observer&&(this._observer.disconnect(),this._observer=null)}syncChains(){document.querySelectorAll("audio, video").forEach(e=>{const t=this._nodesByElement.get(e);t&&this._setChainEnabled(t,this._enabled)})}}const V="crt-overlay-root",H="#crt-curve-inner",F=8,D=20;class U{constructor(){f(this,"_noiseFrameId",null);f(this,"_noiseCanvas",null);this._root=null}getRoot(){return this._root?this._root:(this._root=this._createDOM(),document.body.appendChild(this._root),this._root)}_createDOM(){const e=document.createElement("div");e.id=V,e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const t=document.createElement("div");t.id="crt-curve-wrap";const s=document.createElement("div");s.id="crt-curve-inner",["crt-scanlines","crt-vignette","crt-chromatic","crt-glitch-phase"].forEach(a=>{const c=document.createElement("div");c.id=a,s.appendChild(c)});const l=document.createElement("div");l.id="crt-glitch-noise-wrap";const u=document.createElement("canvas");return u.id="crt-glitch-noise",l.appendChild(u),s.appendChild(l),t.appendChild(s),e.appendChild(t),e}applyOptions(e={}){const t=this.getRoot(),s=t.querySelector(H);if(!s)return;s.style.setProperty("--crt-scanline",String(e.scanline??r[n.SCANLINE])),s.style.setProperty("--crt-vignette",String(e.vignette??r[n.VIGNETTE])),s.style.setProperty("--crt-glow",String(e.glow??r[n.GLOW]));const i=e.curvature??r[n.CURVATURE],l=Math.max(0,F+i*D);s.style.borderRadius=`${l}%`;const u=e.vhsGlitches??r[n.VHS_GLITCHES],a=e.glitchPhaseLevel??r[n.GLITCH_PHASE_LEVEL],c=e.glitchNoiseLevel??r[n.GLITCH_NOISE_LEVEL];u?(t.setAttribute("data-glitches","true"),t.style.setProperty("--crt-glitch-phase",String(a)),t.style.setProperty("--crt-glitch-noise",String(c)),this._startNoiseCanvas(c)):(t.removeAttribute("data-glitches"),this._stopNoiseCanvas())}_startNoiseCanvas(e){this._stopNoiseCanvas();const t=this.getRoot().querySelector("#crt-glitch-noise-wrap"),s=this.getRoot().querySelector("#crt-glitch-noise");if(!t||!s)return;this._noiseCanvas=s;const i=256;s.width=i,s.height=i,t.style.display="block";const l=s.getContext("2d",{willReadFrequently:!0}),u=l.getImageData(0,0,i,i),a=u.data,c=()=>{if(!this._noiseCanvas||!this.getRoot().hasAttribute("data-glitches"))return;const E=parseFloat(this.getRoot().style.getPropertyValue("--crt-glitch-noise")||"0.15");for(let h=0;h<a.length;h+=4){const w=Math.floor(Math.random()*256);a[h]=a[h+1]=a[h+2]=w,a[h+3]=Math.floor(E*80)}l.putImageData(u,0,0),this._noiseFrameId=requestAnimationFrame(c)};c()}_stopNoiseCanvas(){this._noiseFrameId!=null&&(cancelAnimationFrame(this._noiseFrameId),this._noiseFrameId=null);const e=this.getRoot().querySelector("#crt-glitch-noise-wrap");e&&(e.style.display="none"),this._noiseCanvas=null}setVisible(e){const t=this.getRoot();e?(t.setAttribute("data-visible","true"),t.hasAttribute("data-glitches")&&this._startNoiseCanvas(parseFloat(t.style.getPropertyValue("--crt-glitch-noise")||"0.15"))):(t.removeAttribute("data-visible"),this._stopNoiseCanvas())}initFromStorage(e){const t={};for(const s of O){const i=I[s];i&&(t[i]=e[s]??r[s])}t.vhsGlitches=e[n.VHS_GLITCHES]??r[n.VHS_GLITCHES],t.glitchPhaseLevel=e[n.GLITCH_PHASE_LEVEL]??r[n.GLITCH_PHASE_LEVEL],t.glitchNoiseLevel=e[n.GLITCH_NOISE_LEVEL]??r[n.GLITCH_NOISE_LEVEL],this.getRoot(),this.applyOptions(t),e[n.ENABLED]&&this.setVisible(!0)}handleMessage(e){if(e.type===d.TOGGLE)return this.setVisible(e.enabled),L(!0);if(e.type===d.SET_OPTIONS){const t=e.options||{};return this.applyOptions(t),this.setVisible(e.visible!==!1),L(!0)}return e.type===d.GET_STATE?new Promise(t=>{S.get(n.ENABLED,s=>{t(L(!0,{enabled:!!s[n.ENABLED]}))})}):null}}const C=new U,g=new G;chrome.runtime.onMessage.addListener((o,e,t)=>{const s=C.handleMessage(o);if(o.type===d.SET_OPTIONS&&o.options){const i=o.options;g.setEnabled(i.soundFilter,i.soundEffectLevel,i.soundNoiseLevel)}return s&&typeof s.then=="function"?(s.then(t),!0):s!=null?(t(s),!0):!1});function N(){S.get(_,o=>{C.initFromStorage(o);const e=o[n.SOUND_FILTER]??r[n.SOUND_FILTER],t=o[n.SOUND_EFFECT_LEVEL]??r[n.SOUND_EFFECT_LEVEL],s=o[n.SOUND_NOISE_LEVEL]??r[n.SOUND_NOISE_LEVEL];g.setEnabled(!!e,t,s)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",N):N()})();
