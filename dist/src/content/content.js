var Y=Object.defineProperty;var Q=(f,p,n)=>p in f?Y(f,p,{enumerable:!0,configurable:!0,writable:!0,value:n}):f[p]=n;var L=(f,p,n)=>Q(f,typeof p!="symbol"?p+"":p,n);(function(){"use strict";const p=[{name:"ENABLED",key:"crtEnabled",default:!1,type:"checkbox",popupId:"crt-enabled",contentKey:null},{name:"SOUND_FILTER",key:"soundFilterEnabled",default:!1,type:"checkbox",popupId:"crt-sound-filter",contentKey:"soundFilter"},{name:"SOUND_EFFECT_LEVEL",key:"soundEffectLevel",default:.8,type:"slider",popupId:"sound-effect-level",fillId:"sound-effect-fill",min:0,max:1},{name:"SOUND_NOISE_LEVEL",key:"soundNoiseLevel",default:.6,type:"slider",popupId:"sound-noise-level",fillId:"sound-noise-fill",min:0,max:1},{name:"SOUND_OVERRIDE_LEVEL",key:"soundOverdriveLevel",default:0,type:"slider",popupId:"sound-overdrive-level",fillId:"sound-overdrive-fill",min:0,max:1},{name:"SOUND_CHORUS_LEVEL",key:"soundChorusLevel",default:0,type:"slider",popupId:"sound-chorus-level",fillId:"sound-chorus-fill",min:0,max:1},{name:"VHS_GLITCHES",key:"vhsGlitchesEnabled",default:!1,type:"checkbox",popupId:"crt-vhs-glitches",contentKey:"vhsGlitches"},{name:"GLITCH_PHASE_LEVEL",key:"glitchPhaseLevel",default:.3,type:"slider",popupId:"glitch-phase-level",fillId:"glitch-phase-fill",min:0,max:1},{name:"GLITCH_NOISE_LEVEL",key:"glitchNoiseLevel",default:.15,type:"slider",popupId:"glitch-noise-level",fillId:"glitch-noise-fill",min:0,max:1},{name:"GLITCH_TRACKING_LEVEL",key:"glitchTrackingLevel",default:.5,type:"slider",popupId:"glitch-tracking-level",fillId:"glitch-tracking-fill",min:0,max:1},{name:"GLITCH_WOBBLE_LEVEL",key:"glitchWobbleLevel",default:.3,type:"slider",popupId:"glitch-wobble-level",fillId:"glitch-wobble-fill",min:0,max:1},{name:"GLITCH_HEADSWITCH_LEVEL",key:"glitchHeadswitchLevel",default:.25,type:"slider",popupId:"glitch-headswitch-level",fillId:"glitch-headswitch-fill",min:0,max:1},{name:"GLITCH_RGB_LEVEL",key:"glitchRgbLevel",default:.35,type:"slider",popupId:"glitch-rgb-level",fillId:"glitch-rgb-fill",min:0,max:1},{name:"GLITCH_DROPOUT_LEVEL",key:"glitchDropoutLevel",default:.2,type:"slider",popupId:"glitch-dropout-level",fillId:"glitch-dropout-fill",min:0,max:1},{name:"GLITCH_REWIND_LEVEL",key:"glitchRewindLevel",default:.4,type:"slider",popupId:"glitch-rewind-level",fillId:"glitch-rewind-fill",min:0,max:1},{name:"SCANLINE",key:"scanlineIntensity",default:.4,type:"slider",popupId:"scanline",fillId:"scanline-fill",min:0,max:1,optionName:"scanline"},{name:"VIGNETTE",key:"vignetteIntensity",default:.5,type:"slider",popupId:"vignette",fillId:"vignette-fill",min:0,max:1,optionName:"vignette"},{name:"GLOW",key:"glowIntensity",default:.15,type:"slider",popupId:"glow",fillId:"glow-fill",min:0,max:.8,optionName:"glow"}],n=Object.fromEntries(p.map(o=>[o.name,o.key])),a=Object.fromEntries(p.map(o=>[o.key,o.default])),V=p.map(o=>o.key),C=p.filter(o=>o.type==="slider"),D=p.filter(o=>o.optionName).map(o=>o.key),M=Object.fromEntries(p.filter(o=>o.optionName).map(o=>[o.key,o.optionName]));Object.fromEntries(p.filter(o=>o.optionName).map(o=>[o.optionName,o.key])),Object.fromEntries(p.filter(o=>o.popupId).map(o=>[o.name,o.popupId])),Object.fromEntries(C.map(o=>[o.popupId,{min:o.min,max:o.max}])),Object.fromEntries(p.filter(o=>o.fillId).map(o=>[o.popupId,o.fillId])),Object.fromEntries(C.map(o=>[o.popupId,o.key]));const g={TOGGLE:"toggle",SET_OPTIONS:"setOptions",GET_STATE:"getState"};function b(o,e=void 0){return e===void 0?{ok:o}:{ok:o,data:e}}const S={get(o,e){chrome.storage.local.get(o,e)},set(o,e){chrome.storage.local.set(o,e??(()=>{}))}},k="crt-overlay-root",x="#crt-curve-inner";class F{constructor(){L(this,"_noiseFrameId",null);L(this,"_noiseCanvas",null);L(this,"_noiseFrameCount",0);L(this,"_dropoutFrameId",null);L(this,"_dropoutTimeoutId",null);L(this,"_dropoutCanvas",null);this._root=null}getRoot(){return this._root?this._root:(this._root=this._createDOM(),document.body.appendChild(this._root),this._resizeOverlay(),this._resizeObserver=new ResizeObserver(()=>this._resizeOverlay()),this._resizeObserver.observe(document.documentElement),this._resizeScrollListener=()=>{this._resizeScrollTimer&&clearTimeout(this._resizeScrollTimer),this._resizeScrollTimer=setTimeout(()=>{this._resizeScrollTimer=null,this._resizeOverlay()},100)},window.addEventListener("scroll",this._resizeScrollListener,{passive:!0}),this._root)}_createDOM(){const e=document.createElement("div");e.id=k,e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const t=document.createElement("div");t.id="crt-curve-wrap";const i=document.createElement("div");i.id="crt-curve-inner",["crt-scanlines","crt-vignette","crt-glow","crt-chromatic","crt-glitch-phase","crt-tracking-lines","crt-headswitch"].forEach(y=>{const d=document.createElement("div");d.id=y,i.appendChild(d)});const l=document.createElement("div");l.id="crt-vhs-rgb-overlay";const h=document.createElement("div");h.id="crt-vhs-rgb-red";const r=document.createElement("div");r.id="crt-vhs-rgb-green";const c=document.createElement("div");c.id="crt-vhs-rgb-cyan",l.appendChild(h),l.appendChild(r),l.appendChild(c),i.appendChild(l);const u=document.createElement("div");u.id="crt-vhs-rewind",i.appendChild(u);const m=document.createElement("div");m.id="crt-glitch-noise-wrap";const v=document.createElement("canvas");v.id="crt-glitch-noise",m.appendChild(v),i.appendChild(m);const _=document.createElement("div");_.id="crt-glitch-dropout-wrap";const E=document.createElement("canvas");return E.id="crt-glitch-dropout",_.appendChild(E),i.appendChild(_),t.appendChild(i),e.appendChild(t),e}_resizeOverlay(){if(!this._root)return;const e=document.documentElement,t=Math.max(e.scrollWidth,e.clientWidth),i=Math.max(e.scrollHeight,e.clientHeight);this._root.style.width=t+"px",this._root.style.height=i+"px"}applyOptions(e={}){const t=this.getRoot(),i=t.querySelector(x);if(!i)return;i.style.setProperty("--crt-scanline",String(e.scanline??a[n.SCANLINE])),i.style.setProperty("--crt-vignette",String(e.vignette??a[n.VIGNETTE])),i.style.setProperty("--crt-glow",String(e.glow??a[n.GLOW]));const s=e.vhsGlitches??a[n.VHS_GLITCHES],l=e.glitchPhaseLevel??a[n.GLITCH_PHASE_LEVEL],h=e.glitchNoiseLevel??a[n.GLITCH_NOISE_LEVEL],r=e.glitchTrackingLevel??a[n.GLITCH_TRACKING_LEVEL],c=e.glitchWobbleLevel??a[n.GLITCH_WOBBLE_LEVEL],u=e.glitchHeadswitchLevel??a[n.GLITCH_HEADSWITCH_LEVEL],m=e.glitchRgbLevel??a[n.GLITCH_RGB_LEVEL],v=e.glitchDropoutLevel??a[n.GLITCH_DROPOUT_LEVEL],_=e.glitchRewindLevel??a[n.GLITCH_REWIND_LEVEL];if(s){t.setAttribute("data-glitches","true"),t.style.setProperty("--crt-glitch-phase",String(l)),t.style.setProperty("--crt-glitch-noise",String(h)),t.style.setProperty("--crt-tracking-lines",String(r)),t.style.setProperty("--crt-wobble-px",c>.01?String(.5+c*2.5):"0"),t.style.setProperty("--crt-headswitch",String(u)),t.style.setProperty("--crt-glitch-dropout",String(v)),t.style.setProperty("--crt-rewind",String(_));const E=t.querySelector("#crt-vhs-rewind");E&&(E.style.display=_>.01?"block":"none"),this._startNoiseCanvas(h),this._applyRgbFilter(m),this._startDropoutCanvas(v),c>.01&&t.hasAttribute("data-visible")?(document.body.classList.add("crt-body-wobble"),document.body.style.setProperty("--crt-wobble-px",String(.5+c*2.5))):(document.body.classList.remove("crt-body-wobble"),document.body.style.removeProperty("--crt-wobble-px"))}else{t.removeAttribute("data-glitches");const E=t.querySelector("#crt-vhs-rewind");E&&(E.style.display="none"),this._stopNoiseCanvas(),this._stopDropoutCanvas(),this._applyRgbFilter(0),document.body.classList.remove("crt-body-wobble"),document.body.style.removeProperty("--crt-wobble-px")}}_applyRgbFilter(e){const t=this.getRoot(),i=Math.round(e*14),s=Math.min(1,.25+e*.7);t.style.setProperty("--crt-rgb-px",String(i)),t.style.setProperty("--crt-rgb-opacity",String(s));const l=t.querySelector("#crt-vhs-rgb-overlay");l&&(l.style.display=e>.01?"block":"none")}_startNoiseCanvas(e){this._stopNoiseCanvas();const t=this.getRoot().querySelector("#crt-glitch-noise-wrap"),i=this.getRoot().querySelector("#crt-glitch-noise");if(!t||!i)return;this._noiseCanvas=i;const s=320;i.width=s,i.height=s,t.style.display="block";const l=i.getContext("2d",{willReadFrequently:!1,alpha:!0}),h=l.createImageData(s,s),r=h.data;this._noiseFrameCount=0;const c=()=>{if(!this._noiseCanvas||!this.getRoot().hasAttribute("data-glitches"))return;if(this._noiseFrameCount++,this._noiseFrameCount%2!==0){this._noiseFrameId=requestAnimationFrame(c);return}const u=parseFloat(this.getRoot().style.getPropertyValue("--crt-glitch-noise")||"0.15"),m=Math.floor(u*120),v=this._noiseFrameCount*.02;for(let _=0;_<s;_++){const E=.4+.6*(.5+.5*Math.sin(_*.05+v));for(let y=0;y<s;y++){const d=(_*s+y)*4;if(Math.random()<.1){r[d]=r[d+1]=r[d+2]=0,r[d+3]=0;continue}const T=Math.random();T<.25?(r[d]=255,r[d+1]=0,r[d+2]=0):T<.5?(r[d]=0,r[d+1]=255,r[d+2]=0):T<.75?(r[d]=0,r[d+1]=0,r[d+2]=255):r[d]=r[d+1]=r[d+2]=Math.random()*256|0,r[d+3]=Math.floor(m*E*(.5+.5*Math.random()))}}l.putImageData(h,0,0),this._noiseFrameId=requestAnimationFrame(c)};c()}_stopNoiseCanvas(){this._noiseFrameId!=null&&(cancelAnimationFrame(this._noiseFrameId),this._noiseFrameId=null);const e=this.getRoot().querySelector("#crt-glitch-noise-wrap");e&&(e.style.display="none"),this._noiseCanvas=null}_startDropoutCanvas(e){if(this._stopDropoutCanvas(),e<.02)return;const t=this.getRoot().querySelector("#crt-glitch-dropout-wrap"),i=this.getRoot().querySelector("#crt-glitch-dropout");if(!t||!i)return;this._dropoutCanvas=i;const s=256,l=256;i.width=s,i.height=l,t.style.display="block",t.style.opacity=String(e);const h=i.getContext("2d",{willReadFrequently:!1,alpha:!0}),r=()=>{if(!this._dropoutCanvas||!this.getRoot().hasAttribute("data-glitches"))return;h.clearRect(0,0,s,l);const c=8+Math.floor(e*24);for(let u=0;u<c;u++){const m=Math.floor(Math.random()*(l-10)),v=Math.random()<.15,_=v?4+Math.floor(Math.random()*5):Math.random()>.6?2:1,E=v?.7+Math.random()*.3:.35+Math.random()*.5;h.fillStyle=`rgba(0,0,0,${E})`,h.fillRect(0,m,s,_)}this._dropoutTimeoutId=setTimeout(()=>{this._dropoutFrameId=requestAnimationFrame(r)},50+Math.random()*80)};r()}_stopDropoutCanvas(){this._dropoutFrameId!=null&&(cancelAnimationFrame(this._dropoutFrameId),this._dropoutFrameId=null),this._dropoutTimeoutId!=null&&(clearTimeout(this._dropoutTimeoutId),this._dropoutTimeoutId=null);const e=this.getRoot().querySelector("#crt-glitch-dropout-wrap");e&&(e.style.display="none",e.style.opacity=""),this._dropoutCanvas=null}setVisible(e){const t=this.getRoot();if(e){if(t.setAttribute("data-visible","true"),t.hasAttribute("data-glitches")){this._startNoiseCanvas(parseFloat(t.style.getPropertyValue("--crt-glitch-noise")||"0.15"));const i=t.style.getPropertyValue("--crt-wobble-px");i&&parseFloat(i)>0&&(document.body.classList.add("crt-body-wobble"),document.body.style.setProperty("--crt-wobble-px",i))}}else t.removeAttribute("data-visible"),this._stopNoiseCanvas(),this._stopDropoutCanvas(),document.body.classList.remove("crt-body-wobble"),document.body.style.removeProperty("--crt-wobble-px")}initFromStorage(e){const t={};for(const i of D){const s=M[i];s&&(t[s]=e[i]??a[i])}t.vhsGlitches=e[n.VHS_GLITCHES]??a[n.VHS_GLITCHES],t.glitchPhaseLevel=e[n.GLITCH_PHASE_LEVEL]??a[n.GLITCH_PHASE_LEVEL],t.glitchNoiseLevel=e[n.GLITCH_NOISE_LEVEL]??a[n.GLITCH_NOISE_LEVEL],t.glitchTrackingLevel=e[n.GLITCH_TRACKING_LEVEL]??a[n.GLITCH_TRACKING_LEVEL],t.glitchWobbleLevel=e[n.GLITCH_WOBBLE_LEVEL]??a[n.GLITCH_WOBBLE_LEVEL],t.glitchHeadswitchLevel=e[n.GLITCH_HEADSWITCH_LEVEL]??a[n.GLITCH_HEADSWITCH_LEVEL],t.glitchRgbLevel=e[n.GLITCH_RGB_LEVEL]??a[n.GLITCH_RGB_LEVEL],t.glitchDropoutLevel=e[n.GLITCH_DROPOUT_LEVEL]??a[n.GLITCH_DROPOUT_LEVEL],t.glitchRewindLevel=e[n.GLITCH_REWIND_LEVEL]??a[n.GLITCH_REWIND_LEVEL],this.getRoot(),this.applyOptions(t),e[n.ENABLED]&&this.setVisible(!0)}handleMessage(e){if(e.type===g.TOGGLE)return this.setVisible(e.enabled),b(!0);if(e.type===g.SET_OPTIONS){const t=e.options||{};return this.applyOptions(t),this.setVisible(e.visible!==!1),b(!0)}return e.type===g.GET_STATE?new Promise(t=>{S.get(n.ENABLED,i=>{t(b(!0,{enabled:!!i[n.ENABLED]}))})}):null}}function P(){var o,e;try{const t=(e=(o=chrome==null?void 0:chrome.runtime)==null?void 0:o.getManifest)==null?void 0:e.call(o);return!(t!=null&&t.update_url)}catch{return!1}}function I(o,e){P()&&(e!=null?console.warn(`[CRT Overlay] ${o}`,e):console.warn(`[CRT Overlay] ${o}`))}const O="data-crt-sound-hooked",W=2e3,B=.5,R=.06,U=1,w=20,q=8,z=1.2;function N(o){if(o<=0)return null;const e=2*o,t=new Float32Array(256);for(let i=0;i<256;i++){const s=i/128-1;t[i]=(3+e)*s*20*(Math.PI/180)/(Math.PI+e*Math.abs(s))}return t}function K(o,e=3){const t=o.sampleRate,i=t*e,s=o.createBuffer(1,i,t),l=s.getChannelData(0);let h=0,r=0,c=0;for(let u=0;u<i;u++){const m=(Math.random()*2-1)*.5;h=.99886*h+m*.0555179,r=.99332*r+m*.0750759,c=.969*c+m*.153852,l[u]=h+r+c}return s}class j{constructor(){this._ctx=null,this._enabled=!1,this._effectLevel=.8,this._noiseLevel=.6,this._overdriveLevel=0,this._chorusLevel=0,this._chorusDelays=new Set,this._chorusRafId=null,this._nodesByElement=new WeakMap,this._observer=null,this._observerThrottleTimer=null,this._resumeOnInteraction=null}_getContext(){return this._ctx||(this._ctx=new(window.AudioContext||window.webkitAudioContext)),this._ctx}_ensureContextRunning(){const e=this._ctx;if(!e||e.state==="running")return Promise.resolve();const t=e.resume();return t&&typeof t.then=="function"?t.catch(i=>I("VHS sound: AudioContext resume failed",i)):Promise.resolve()}_addResumeOnInteraction(){if(this._resumeOnInteraction)return;const e=()=>{this._ensureContextRunning(),document.removeEventListener("click",e),document.removeEventListener("touchstart",e),document.removeEventListener("keydown",e),this._resumeOnInteraction=null};this._resumeOnInteraction=e,document.addEventListener("click",e,{passive:!0}),document.addEventListener("touchstart",e,{passive:!0}),document.addEventListener("keydown",e,{passive:!0})}_createChain(e,t){const i=e.createGain(),s=e.createBiquadFilter();s.type="lowpass",s.frequency.value=W,s.Q.value=B;const l=e.createWaveShaper(),h=N(this._overdriveLevel);l.curve=h,l.oversample="2x";const r=e.createGain(),c=e.createDelay(.06);c.delayTime.value=w/1e3;const u=e.createGain();u.gain.value=0,t.connect(c),c.connect(u),u.connect(r),this._chorusDelays.add(c);const m=K(e),v=e.createBufferSource();v.buffer=m,v.loop=!0;const _=e.createGain();_.gain.value=this._noiseLevel*R,t.connect(i),i.connect(e.destination),t.connect(s),s.connect(l),l.connect(r),r.connect(e.destination),v.connect(_),_.connect(e.destination);try{v.start(0)}catch(E){I("VHS sound: noise source start failed",E)}return{dryGain:i,effectGain:r,noiseGain:_,waveshaper:l,chorusGain:u}}_chorusLfoTick(){const e=this._ctx;if(!e||this._chorusDelays.size===0||this._chorusLevel<=0)return;const t=e.currentTime,i=w/1e3+q/1e3*Math.sin(2*Math.PI*z*t);this._chorusDelays.forEach(s=>{s.delayTime.setTargetAtTime(i,t,.01)}),this._chorusRafId=requestAnimationFrame(()=>this._chorusLfoTick())}_startChorusLfo(){this._chorusRafId!=null||this._chorusLevel<=0||(this._chorusRafId=requestAnimationFrame(()=>this._chorusLfoTick()))}_stopChorusLfo(){this._chorusRafId!=null&&(cancelAnimationFrame(this._chorusRafId),this._chorusRafId=null)}_hookElement(e){if(!e.hasAttribute(O))try{const t=this._getContext(),i=t.createMediaElementSource(e),s=this._createChain(t,i);this._nodesByElement.set(e,{source:i,...s}),e.setAttribute(O,"1"),this._setChainEnabled(s,this._enabled)}catch(t){I("VHS sound: hook element failed (e.g. CORS)",t)}}_setChainEnabled(e,t){if(!e)return;const i=t?Math.pow(this._effectLevel,.85):0,s=i*U,l=t?Math.max(0,1-i):1;e.dryGain.gain.value=l,e.effectGain.gain.value=s;const h=t?Math.pow(this._noiseLevel,1.6):0;if(e.noiseGain.gain.value=h*R,e.waveshaper){const c=N(t?this._overdriveLevel:0);e.waveshaper.curve=c}const r=t?Math.pow(this._chorusLevel,.9)*.4:0;e.chorusGain&&(e.chorusGain.gain.value=r),t&&this._chorusLevel>0?this._startChorusLfo():this._chorusLevel<=0&&this._stopChorusLfo()}setLevels(e,t,i,s){this._effectLevel=Math.max(0,Math.min(1,Number(e)||0)),this._noiseLevel=Math.max(0,Math.min(1,Number(t)||0)),this._overdriveLevel=Math.max(0,Math.min(1,Number(i)??0)),this._chorusLevel=Math.max(0,Math.min(1,Number(s)??0)),this._chorusLevel<=0&&this._stopChorusLfo(),document.querySelectorAll("audio, video").forEach(l=>{const h=this._nodesByElement.get(l);h&&this._setChainEnabled(h,this._enabled)})}_scanAndHook(){document.querySelectorAll("audio, video").forEach(t=>this._hookElement(t))}setEnabled(e,t,i,s,l){e!==void 0&&(this._enabled=!!e),t!==void 0&&(this._effectLevel=Math.max(0,Math.min(1,Number(t)||0))),i!==void 0&&(this._noiseLevel=Math.max(0,Math.min(1,Number(i)||0))),s!==void 0&&(this._overdriveLevel=Math.max(0,Math.min(1,Number(s)??0))),l!==void 0&&(this._chorusLevel=Math.max(0,Math.min(1,Number(l)??0))),(!this._enabled||this._chorusLevel<=0)&&this._stopChorusLfo(),this._enabled?(this._ensureContextRunning().then(()=>{this._scanAndHook(),this._observe()}),this._addResumeOnInteraction()):this._disconnectObserver(),this.syncChains()}_observe(){if(this._observer)return;const e=document.body||document.documentElement;if(!e)return;const t=250;this._observer=new MutationObserver(()=>{this._enabled&&this._observerThrottleTimer==null&&(this._observerThrottleTimer=setTimeout(()=>{this._observerThrottleTimer=null,this._scanAndHook()},t))}),this._observer.observe(e,{childList:!0,subtree:!0})}_disconnectObserver(){this._observerThrottleTimer!=null&&(clearTimeout(this._observerThrottleTimer),this._observerThrottleTimer=null),this._observer&&(this._observer.disconnect(),this._observer=null)}syncChains(){document.querySelectorAll("audio, video").forEach(e=>{const t=this._nodesByElement.get(e);t&&this._setChainEnabled(t,this._enabled)})}}const G=new F,H=new j;chrome.runtime.onMessage.addListener((o,e,t)=>{const i=G.handleMessage(o);if(o.type===g.SET_OPTIONS&&o.options){const s=o.options;H.setEnabled(s.soundFilter,s.soundEffectLevel,s.soundNoiseLevel,s.soundOverdriveLevel,s.soundChorusLevel)}return i&&typeof i.then=="function"?(i.then(t),!0):i!=null?(t(i),!0):!1});function A(){S.get(V,o=>{G.initFromStorage(o);const e=o[n.SOUND_FILTER]??a[n.SOUND_FILTER],t=o[n.SOUND_EFFECT_LEVEL]??a[n.SOUND_EFFECT_LEVEL],i=o[n.SOUND_NOISE_LEVEL]??a[n.SOUND_NOISE_LEVEL],s=o[n.SOUND_OVERRIDE_LEVEL]??a[n.SOUND_OVERRIDE_LEVEL],l=o[n.SOUND_CHORUS_LEVEL]??a[n.SOUND_CHORUS_LEVEL];H.setEnabled(!!e,t,i,s,l)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A()})();
